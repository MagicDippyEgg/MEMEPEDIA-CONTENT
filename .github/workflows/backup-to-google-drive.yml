name: Backup GitHub Repo to Google Drive

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch (or modify this for other branches)

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Checkout Repo
        uses: actions/checkout@v2

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      # Install required dependencies
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      # Authenticate with Google Drive API
      - name: Authenticate with Google Drive API
        env:
          GOOGLE_DRIVE_CLIENT_ID: ${{ secrets.GOOGLE_DRIVE_CLIENT_ID }}
          GOOGLE_DRIVE_CLIENT_SECRET: ${{ secrets.GOOGLE_DRIVE_CLIENT_SECRET }}
          GOOGLE_DRIVE_REFRESH_TOKEN: ${{ secrets.GOOGLE_DRIVE_REFRESH_TOKEN }}
        run: |
          python -c "
          from google.oauth2.credentials import Credentials
          from google_auth_oauthlib.flow import InstalledAppFlow
          from google_auth_httplib2 import AuthorizedHttp
          from googleapiclient.discovery import build
          import os

          creds = Credentials.from_authorized_user_info(
              client_id=os.getenv('GOOGLE_DRIVE_CLIENT_ID'),
              client_secret=os.getenv('GOOGLE_DRIVE_CLIENT_SECRET'),
              refresh_token=os.getenv('GOOGLE_DRIVE_REFRESH_TOKEN')
          )

          service = build('drive', 'v3', credentials=creds)

          # Upload the repository files
          folder_id = 'your_folder_id_here'  # Optionally specify a folder ID in Google Drive
          file_metadata = {'name': 'backup_repo.zip', 'parents': [folder_id]}
          media = MediaFileUpload('repo.zip', mimetype='application/zip')

          file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
          print(f'Uploaded file ID: {file["id"]}')
          "

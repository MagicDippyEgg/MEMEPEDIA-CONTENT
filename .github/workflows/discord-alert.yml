name: Discord Alert on Push

on:
  push:
    branches:
      - main

jobs:
  alert:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord embed alert with multiple commits
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          COMMITS=$(jq -r '.commits[] | "- [`\(.id[0:7])`](\(.url)) \(.message | gsub("\n"; " "))"' $GITHUB_EVENT_PATH)

          curl -H "Content-Type: application/json" -X POST -d "{
            \"embeds\": [{
              \"title\": \"ðŸš€ New Push to ${GITHUB_REPO}\",
              \"description\": \"**Author:** [${GITHUB_ACTOR}](https://github.com/${GITHUB_ACTOR})\\n**Branch:** ${GITHUB_REF_NAME}\\n**Commits:**\\n${COMMITS}\",
              \"color\": 5814783,
              \"timestamp\": \"$(date --utc +%Y-%m-%dT%H:%M:%SZ)\",
              \"author\": {
                \"name\": \"${GITHUB_ACTOR}\",
                \"url\": \"https://github.com/${GITHUB_ACTOR}\",
                \"icon_url\": \"https://github.com/${GITHUB_ACTOR}.png\"
              }
            }]
          }" $DISCORD_WEBHOOK_URL
